<!doctype html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>Canvas Drag and Drop Test</title>
</head>
<body>
	<section>
		<div>
			<button type="button" onclick="actionAddNode()"> Add</button>
		</div>
		<div>
			<canvas id="canvas" width="800" height="800">
				This text is displayed if your browser does not support HTML5 Canvas.
			</canvas>
		</div>

		<script type="text/javascript">

			var canvas;
			var currentGrag;
			var ctx;
			var listNode = new Array(100);
			var indexList = 0;
			var WIDTH = 800;
			var HEIGHT = 800;
			var dragok = false;
			var turnOnAddNode = false;

			function rect() {
				for(var i = 0; i <= indexList; i++)
				{
					ctx.beginPath();
					ctx.rect(listNode[i].posx, listNode[i].posy, 60, 60);
					ctx.stroke();
					ctx.closePath();
				}
			}

			function triangle(){
				ctx.beginPath();
/*				ctx.moveTo(listNode[0].posx, listNode[0].posy);
				ctx.lineTo(listNode[1].posx, listNode[1].posy);*/
				var headlen = 10;
				var angle = Math.atan2(listNode[1].posy - listNode[0].posy, listNode[1].posx - listNode[0].posx);
                ctx.moveTo(listNode[0].posx, listNode[0].posy);
                ctx.lineTo(listNode[1].posx, listNode[1].posy);
                ctx.lineTo(listNode[1].posx - headlen*Math.cos(angle-Math.PI/6), listNode[1].posy -headlen*Math.sin(angle-Math.PI/6));
                ctx.moveTo(listNode[1].posx, listNode[1].posy);
                ctx.lineTo(listNode[1].posx - headlen*Math.cos(angle+Math.PI/6),listNode[1].posy - headlen*Math.sin(angle+Math.PI/6))
				ctx.stroke();
				ctx.closePath();
			}

			function circle(){
				for(var i = 0; i <= indexList; i++)
				{
					ctx.beginPath();
					ctx.arc(listNode[i].posx, listNode[i].posy, 30, 0, 2 * Math.PI, false);
					ctx.stroke();
					ctx.closePath();
				}
			}

				function clear() {
					ctx.clearRect(0, 0, WIDTH, HEIGHT);
				}

				function draw() {
					clear();
					triangle();
				//rect();
				circle();
			}

			function init() {
				canvas = document.getElementById("canvas");
				ctx = canvas.getContext("2d");
				return setInterval(draw, 10);
			}

			function myMove(e){
				if (dragok){
					listNode[currentGrag].posx = e.pageX;
					listNode[currentGrag].posy = e.pageY;
				}
			}

			function addNode(x, y, text){
				var node = {
					posx : x,
					posy : y,
					content  : text
				};
				listNode[indexList] = node;
				indexList = indexList + 1;
			}

			function actionAddNodeDown(e){
				addNode(e.pageX, e.pageY, "Node1");
				canvas.onmousedown = myDown;
			}

			function actionAddNode(){
				canvas.onmousedown = actionAddNodeDown;
			}

			function myDown(e){
				for(var i = 0; i < listNode.length; i++)
				{
					if((e.pageX >= listNode[i].posx) && (e.pageX <= listNode[i].posx + 60) && (e.pageY >= listNode[i].posy) && (e.pageY <= listNode[i].posy + 60))
					{
						dragok = true;
						canvas.onmousemove = myMove;
						currentGrag = i;
					}
				}
			}

			function myUp(){
				dragok = false;
				canvas.onmousemove = null;
			}

			addNode(100, 100, "Node 1");
			addNode(100, 200, "Node 2");
			init();
			//draw();
				canvas.onmousedown = myDown;
				canvas.onmouseup = myUp;

			</script>

		</section>
	</body>
	</html>