<!doctype html>
<html>
<head>
	<meta charset="UTF-8" />
	<title>Canvas Drag and Drop Test</title>
</head>
<body>
	<section>
		<div>
			<button type="button" onclick="actionAddNode()"> AddNode</button>
			<button type="button" onclick="actionDelNode()"> DelNode</button>
			<button type="button" onclick="actionAddLink()"> Link</button>
			<button type="button" onclick="actionDelLink()"> DelLink</button>
			<button type="button" onclick="actionSetting()"> Setting</button>
		</div>
		<div>
			<canvas id="canvas" width="800" height="300">
				This text is displayed if your browser does not support HTML5 Canvas.
			</canvas>
		</div>

<div>
            <table id="sensor-table" style="width:100%">
  <tr>
    <th>ID</th>
    <th>Name</th>
    <th>MaxSizeOfBuffer</th> 
    <th>Type</th>
  </tr>

</table>

<table id="link-table" style="width:100%">
  <tr>
    <th>ID</th>
    <th>Name</th>
    <th>MaxSizeOfBuffer</th> 
    <th>From</th>
    <th>To</th>
  </tr>

</table>

		<script type="text/javascript">

			var canvas;
			var currentGrag;
			var ctx;
			var listNode = [];
			var indexList = 0;
			var WIDTH = 800;
			var HEIGHT = 800;
			var dragok = false;
			var addLinkFirst = -1;
			var addLinkSecond = -1;
			var delLinkFirst = -1;
			var delLinkSecond = -1;

			function arrow(fromx, fromy, tox, toy){
				    var headlen = 10;   // length of head in pixels
				    var angle = Math.atan2(toy-fromy,tox-fromx);
				    ctx.beginPath();
				    ctx.moveTo(fromx, fromy);
				    ctx.lineTo(tox, toy);
				    ctx.lineTo(tox-headlen*Math.cos(angle-Math.PI/6),toy-headlen*Math.sin(angle-Math.PI/6));
				    ctx.moveTo(tox, toy);
				    ctx.lineTo(tox-headlen*Math.cos(angle+Math.PI/6),toy-headlen*Math.sin(angle+Math.PI/6));
				    ctx.stroke();
				    ctx.closePath();
				}


				function getPointOnCircle(radius, fromx, fromy, tox, toy) {
					var angleInDegrees = getAngleBetweenPoints(fromx, fromy, tox, toy);      
					var x = radius * Math.cos(angleInDegrees * Math.PI / 180) + fromx;
					var y = radius * Math.sin(angleInDegrees * Math.PI / 180) + fromy;

					return { px: x, py: y };
				}

				function getAngleBetweenPoints(fromx, fromy, tox, toy) {
					return Math.atan2(toy - fromy, tox - fromx) * 180 / Math.PI;
				}

				function linetoline(from, to){
					var tf = getPointOnCircle(30, listNode[from].posx, listNode[from].posy,  listNode[to].posx, listNode[to].posy);
					var tt = getPointOnCircle(30, listNode[to].posx, listNode[to].posy,  listNode[from].posx, listNode[from].posy);
					arrow( tf.px, tf.py,  tt.px, tt.py);					
				}

				function networkNode(){
					for(var i = 0; i < indexList; i++){
						if(listNode[i].link.length > 0){
							for(var j = 0; j < listNode[i].link.length; j++){
								linetoline(i, listNode[i].link[j]);
							}
						}
					}
				}

				function circle(){
					for(var i = 0; i < indexList; i++)
					{
						if(listNode[i].id >= 0){
							ctx.beginPath();
							ctx.arc(listNode[i].posx, listNode[i].posy, 30, 0, 2 * Math.PI, false);
							ctx.stroke();
							ctx.closePath();
						}
					}
				}

				function clear() {
					ctx.clearRect(0, 0, WIDTH, HEIGHT);
				}

				function draw() {
					clear();
					networkNode();
					circle();
				}

				function init() {
					canvas = document.getElementById("canvas");
					ctx = canvas.getContext("2d");
					return setInterval(draw, 10);
				//draw();
			}

			function myMove(e){
				if (dragok){
					listNode[currentGrag].posx = e.pageX;
					listNode[currentGrag].posy = e.pageY;
				}
			}

			function addNode(x, y, t, l){
				var node = {
					id   : indexList,
					posx : x,
					posy : y,
					content  : t,
					link : l
				};

				listNode[indexList] = node;
				indexList = indexList + 1;
			}

			function delNode(){

			}

			function actionAddNodeDown(e){
				addNode(e.pageX, e.pageY, "Node1", []);
				canvas.onmousedown = myDown;
                document.getElementById("sensor-table").insertAdjacentHTML('beforeend','<tr><td>1</td><td><input type="text" id="row-1-name" name="row-1-name" value="Sensor1"></td><td><input type="text" id="row-1-maxsizeofbuffer" name="row-1-maxsizeofbuffer" value="50"></td><td><select size="1" id="row-1-type" name="row-1-type"><option value="Source" selected="selected">Source</option><option value="Intermediate">Intermediate</option><option value="Sink">Sink</option></select></td></tr>');
			}

			function delLinkInNode(node){
               for(var i = 0; i < indexList; i++){
               	if(i != node && listNode[i].link.length > 0){
               		var xx = listNode[i].link.indexOf(node);
                    if(xx >= 0){
                    	listNode[i].link.splice(xx, 1);
                    }
               	}
               }
			}

			function actionDelNodeDown(e){
				for(var i = 0; i < indexList; i++)
				{
					if((e.pageX >= listNode[i].posx) && (e.pageX <= listNode[i].posx + 60) && (e.pageY >= listNode[i].posy) && (e.pageY <= listNode[i].posy + 60)){
						listNode[i].id = -1;
						listNode[i].link = [];
						delLinkInNode(i);
						canvas.onmousedown = myDown;
					}
				}
                 
			}

			function actionAddLinkDown(e){
				for(var i = 0; i < indexList; i++)
				{
					if((e.pageX >= listNode[i].posx) && (e.pageX <= listNode[i].posx + 60) && (e.pageY >= listNode[i].posy) && (e.pageY <= listNode[i].posy + 60)){
						if(addLinkFirst < 0){
							addLinkFirst = i;
							alert("First " + addLinkFirst);
						}
						else if(addLinkSecond < 0 && addLinkFirst != i){
							addLinkSecond = i;
							var xx = listNode[addLinkFirst].link.indexOf(addLinkSecond);
							if(xx < 0){
								listNode[addLinkFirst].link.push(addLinkSecond);
								alert("Second " + addLinkSecond);
							}
							addLinkFirst = -1;
							addLinkSecond = -1;
							canvas.onmousedown = myDown;
						}
					}
				}
			}

			function actionAddLink(){
				canvas.onmousedown = actionAddLinkDown;
			}

			function actionDelLinkDown(e){
				for(var i = 0; i < indexList; i++)
				{
					if((e.pageX >= listNode[i].posx) && (e.pageX <= listNode[i].posx + 60) && (e.pageY >= listNode[i].posy) && (e.pageY <= listNode[i].posy + 60)){
						if(delLinkFirst < 0){
							delLinkFirst = i;
							alert("First " + delLinkFirst);
						}
						else if(delLinkSecond < 0 && delLinkFirst != i){
							delLinkSecond = i;
							alert("Second " + delLinkSecond);
							var xx = listNode[delLinkFirst].link.indexOf(delLinkSecond);
							if(xx >= 0){
								listNode[delLinkFirst].link.splice(xx, 1);
							}
							alert("Index " + xx);
							delLinkFirst = -1;
							delLinkSecond = -1;
							canvas.onmousedown = myDown;
						}
					}
				}
			}

			function actionDelLink(){
				canvas.onmousedown = actionDelLinkDown;
			}

			function actionAddNode(){
				canvas.onmousedown = actionAddNodeDown;
			}

			function actionDelNode(){
				canvas.onmousedown = actionDelNodeDown;
			}

			function myDown(e){
				for(var i = 0; i < indexList; i++)
				{
					if((e.pageX >= listNode[i].posx) && (e.pageX <= listNode[i].posx + 60) && (e.pageY >= listNode[i].posy) && (e.pageY <= listNode[i].posy + 60))
					{
						dragok = true;
						canvas.onmousemove = myMove;
						currentGrag = i;
					}
				}
			}

			function myUp(){
				dragok = false;
				canvas.onmousemove = null;
			}

			function actionSetting(){
				alert("Waiting Viet");
			}

			addNode(100, 100, "Node 1", []);
			addNode(200, 200, "Node 2", []);
			addNode(100, 300, "Node 3", []);
			addNode(400, 100, "Node 4", []);
			init();
			//draw();
			canvas.onmousedown = myDown;
			canvas.onmouseup = myUp;

		</script>

	</section>
</body>
</html>
